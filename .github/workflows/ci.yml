# Continuous Integration
# Runs on every push and pull request to ensure code quality

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# Cancel stale PR runs when new commits are pushed
# Never cancel main branch runs (critical for merge validation)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # ====================
  # Linting (fmt + clippy)
  # ====================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent runaway linting jobs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      # Shared cache for all stable-toolchain jobs (lint, test, shellcheck)
      # Read-only consumer - test job is the authoritative writer
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "stable-ci"
          save-if: "false"  # Don't save cache, only restore

      - name: Check formatting
        run: cargo fmt --all --check

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check llms.txt consistency
        run: |
          set -e

          # Extract MSRV from Cargo.toml
          CARGO_MSRV=$(grep '^rust-version = ' Cargo.toml | head -1 | sed 's/rust-version = "\(.*\)"/\1/')
          echo "Cargo.toml MSRV: $CARGO_MSRV"

          # Check llms-full.txt MSRV
          if grep -q "MSRV $CARGO_MSRV" llms-full.txt; then
            echo "✅ llms-full.txt MSRV is in sync with Cargo.toml"
          else
            echo "❌ llms-full.txt MSRV mismatch"
            echo "Expected: MSRV $CARGO_MSRV"
            grep 'MSRV' llms-full.txt || echo "No MSRV found in llms-full.txt"
            exit 1
          fi

  # ====================
  # Tests
  # ====================
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Test suite + ignored tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: false

      # Shared cache for all stable-toolchain jobs
      # Authoritative writer - produces richest cache (includes test binaries)
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "stable-ci"
          # save-if defaults to true - this job writes the cache

      - name: Run tests
        run: cargo test --all-features --workspace

      - name: Run ignored tests (requires uv)
        run: cargo test --all-features --workspace -- --ignored

  # ====================
  # MSRV (Minimum Supported Rust Version)
  # ====================
  # Tests that code compiles and runs on our minimum supported Rust version.
  # Part of N-1 policy: we support current stable + 1 previous version.
  # Current MSRV: 1.85 (required by Rust Edition 2024)
  #
  # This job is MORE thorough than the test job:
  # - Runs clippy to catch MSRV-specific lint warnings
  # - Explicitly builds to verify compilation on MSRV
  # - Runs full test suite including ignored tests
  #
  # Complements msrv-check.yml which verifies MSRV accuracy with cargo-msrv
  msrv:
    name: MSRV (1.85)
    runs-on: ubuntu-latest
    timeout-minutes: 25  # MSRV can be slower than stable
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      # Install MSRV toolchain with clippy component
      # Must match rust-version in Cargo.toml
      - name: Install Rust toolchain (MSRV)
        uses: dtolnay/rust-toolchain@1.85
        with:
          components: clippy  # Needed for MSRV-specific lint checks

      # Install uv for integration tests that require it
      # Cache disabled to ensure latest uv version
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: false

      # Separate cache for MSRV toolchain (1.85)
      # Different compiler version = incompatible build artifacts
      # Must NOT share cache with stable-toolchain jobs
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "msrv"

      # Step 1: Lint check - catches MSRV-specific clippy warnings
      # Fails on any warnings (-D warnings)
      - name: Run Clippy on MSRV
        run: cargo clippy --all-targets --all-features -- -D warnings

      # Step 2: Build check - verifies code compiles on MSRV
      # Build artifacts are reused by test steps
      - name: Build on MSRV
        run: cargo build --all-features

      # Step 3: Run unit and integration tests
      # 520 unit tests + 43 integration tests
      - name: Run tests on MSRV
        run: cargo test --all-features --workspace

      # Step 4: Run tests that require uv installed
      # These are marked with #[ignore] and need --ignored flag
      - name: Run ignored tests on MSRV
        run: cargo test --all-features --workspace -- --ignored

  # ====================
  # ShellCheck (embedded shell script linting)
  # ====================
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Build + extract + shellcheck
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Shared cache for all stable-toolchain jobs
      # Read-only consumer - test job is the authoritative writer
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "stable-ci"
          save-if: "false"  # Don't save cache, only restore

      - name: Build binary
        run: cargo build

      - name: Extract shell scripts
        run: |
          ./target/debug/scoop init bash > /tmp/bash_init.sh
          ./target/debug/scoop init zsh > /tmp/zsh_init.sh

      - name: ShellCheck bash script
        run: |
          # SC2207: COMPREPLY=($(compgen ...)) is standard bash completion idiom
          shellcheck --shell=bash --severity=warning --exclude=SC2207 /tmp/bash_init.sh

      - name: ShellCheck zsh script
        run: |
          # zsh-specific constructs need exclusions (shellcheck lacks native zsh support)
          # SC1087: $line[1] array syntax, SC2206/SC2296: ${(f)...} expansion flags
          shellcheck --shell=bash --severity=warning \
            --exclude=SC1087,SC2034,SC2154,SC2168,SC2206,SC2207,SC2296,SC3030,SC3057 \
            /tmp/zsh_init.sh
